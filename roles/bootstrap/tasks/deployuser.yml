---
# originally from: https://github.com/phred/5minbootstrap/
# - name: Update APT package cache
#   action: apt update_cache=yes

# - name: Run apt-get upgrade
#   action: command apt-get dist-upgrade

- name: Add deployment user
  action: user name={{ deploy_user }} password={{ deploy_password }} generate_ssh_key=yes shell=/bin/bash

- name: Add authorized deploy key
  action: authorized_key user={{ deploy_user }} key="{{ lookup('file', ssh_public_key_file) }}"

- name: Remove sudo group rights
  action: lineinfile dest=/etc/sudoers regexp="^%sudo" state=absent

- name: Add deploy user to sudoers
  action: 'lineinfile dest=/etc/sudoers regexp="{{ deploy_user }} ALL" line="{{ deploy_user }} ALL=(ALL) NOPASSWD: ALL" state=present'

- name: Disallow root SSH access
  action: lineinfile dest=/etc/ssh/sshd_config regexp="^PermitRootLogin" line="PermitRootLogin no" state=present
  notify: Restart sshd

- name: Disallow password authentication
  action: lineinfile dest=/etc/ssh/sshd_config regexp="^PasswordAuthentication" line="PasswordAuthentication no" state=present
  notify: Restart sshd

handlers:
- name: Restart sshd
  action: service name=ssh state=restarted
